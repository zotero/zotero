#!/bin/bash
set -euo pipefail

# Perform full code signing of DeepTutor.app for local usage
#
# This script performs the same signing process as production builds,
# but uses the configured developer certificate for local development.

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
. "$ROOT_DIR/config.sh"

if [ -z "${1:-}" ]; then
	echo "Usage: $0 path/to/staging/DeepTutor.app"
	exit 1
fi

APPDIR=$1

# If signing is disabled, just do ad-hoc signing for Word plugin
if [ $SIGN != 1 ]; then
	echo "Signing disabled - performing minimal ad-hoc signing"
	entitlements_file="$ROOT_DIR/mac/entitlements.xml"
	find "$APPDIR/Contents" -name 'libZoteroWordIntegration.dylib' -exec /usr/bin/codesign --force --options runtime --entitlements "$entitlements_file" --sign "-" {} \;
	exit 0
fi

# Full signing process (same as production build)
echo "Performing full code signing with certificate: $DEVELOPER_ID"

# Unlock keychain if a password is provided
if [ -n "$KEYCHAIN_PASSWORD" ]; then
	security -v unlock-keychain -p "$KEYCHAIN_PASSWORD" ~/Library/Keychains/$KEYCHAIN.keychain-db
fi

# Clear extended attributes, which can cause codesign to fail
/usr/bin/xattr -cr "$APPDIR"

# Sign libraries and updater without entitlements
/usr/bin/codesign --force --options runtime --timestamp --sign "$DEVELOPER_ID" \
	"$APPDIR/Contents/MacOS/XUL" \
	"$APPDIR/Contents/MacOS/updater.app" \
	"$APPDIR/Contents/Frameworks/ChannelPrefs.framework"

find "$APPDIR/Contents" -name '*.dylib' -print0 | xargs -0 /usr/bin/codesign --force --options runtime --timestamp --sign "$DEVELOPER_ID"

# Sign bundled apps and main app bundle
entitlements_file="$ROOT_DIR/mac/entitlements.xml"
find "$APPDIR/Contents" -name '*.app' -not -name "updater.app" -print0 | xargs -0 /usr/bin/codesign --force --options runtime --timestamp --entitlements "$entitlements_file" --sign "$DEVELOPER_ID"

# Sign final app package
echo
/usr/bin/codesign --force --options runtime --timestamp --entitlements "$entitlements_file" --sign "$DEVELOPER_ID" "$APPDIR"

# Verify app
/usr/bin/codesign --verify -vvvv "$APPDIR"

echo "Code signing completed successfully"
